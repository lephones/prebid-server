
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>smaato: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/prebid/prebid-server/v3/adapters/smaato/banner.go (100.0%)</option>
				
				<option value="file1">github.com/prebid/prebid-server/v3/adapters/smaato/native.go (85.7%)</option>
				
				<option value="file2">github.com/prebid/prebid-server/v3/adapters/smaato/smaato.go (93.3%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package smaato

import (
        "fmt"
        "net/url"
        "strings"
)

func extractAdmBanner(adMarkup string, curls []string) string <span class="cov8" title="1">{
        if len(curls) &gt; 0 </span><span class="cov8" title="1">{
                var clickEvent string
                var clicks strings.Builder
                for _, clicktracker := range curls </span><span class="cov8" title="1">{
                        clicks.WriteString("fetch(decodeURIComponent('" + url.QueryEscape(clicktracker) + "'.replace(/\\+/g, ' ')), " +
                                "{cache: 'no-cache'});")
                }</span>
                <span class="cov8" title="1">clickEvent = fmt.Sprintf(`onclick="%s"`, clicks.String())
                return fmt.Sprintf(`&lt;div style="cursor:pointer" %s&gt;%s&lt;/div&gt;`, clickEvent, adMarkup)</span>
        }

        <span class="cov8" title="1">return adMarkup</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package smaato

import (
        "encoding/json"
        "fmt"

        "github.com/prebid/prebid-server/v3/errortypes"
        "github.com/prebid/prebid-server/v3/util/jsonutil"
)

type nativeAd struct {
        Native json.RawMessage `json:"native"`
}

func extractAdmNative(adMarkup string) (string, error) <span class="cov8" title="1">{
        var nativeAd nativeAd
        if err := jsonutil.Unmarshal([]byte(adMarkup), &amp;nativeAd); err != nil </span><span class="cov8" title="1">{
                return "", &amp;errortypes.BadServerResponse{
                        Message: fmt.Sprintf("Invalid ad markup %s.", adMarkup),
                }
        }</span>
        <span class="cov8" title="1">adm, err := json.Marshal(&amp;nativeAd.Native)
        if err != nil </span><span class="cov0" title="0">{
                return "", &amp;errortypes.BadServerResponse{
                        Message: fmt.Sprintf("Invalid ad markup %s.", adMarkup),
                }
        }</span>
        <span class="cov8" title="1">return string(adm), nil</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package smaato

import (
        "encoding/json"
        "fmt"
        "net/http"
        "strconv"
        "strings"

        "github.com/buger/jsonparser"
        "github.com/prebid/openrtb/v20/openrtb2"
        "github.com/prebid/prebid-server/v3/adapters"
        "github.com/prebid/prebid-server/v3/config"
        "github.com/prebid/prebid-server/v3/errortypes"
        "github.com/prebid/prebid-server/v3/metrics"
        "github.com/prebid/prebid-server/v3/openrtb_ext"
        "github.com/prebid/prebid-server/v3/util/jsonutil"
        "github.com/prebid/prebid-server/v3/util/timeutil"
)

const clientVersion = "prebid_server_1.2"

type adMarkupType string

const (
        smtAdTypeImg       adMarkupType = "Img"
        smtAdTypeRichmedia adMarkupType = "Richmedia"
        smtAdTypeVideo     adMarkupType = "Video"
        smtAdTypeNative    adMarkupType = "Native"
)

// adapter describes a Smaato prebid server adapter.
type adapter struct {
        clock    timeutil.Time
        endpoint string
}

// userExtData defines User.Ext.Data object for Smaato
type userExtData struct {
        Keywords string `json:"keywords"`
        Gender   string `json:"gender"`
        Yob      int64  `json:"yob"`
}

// siteExt defines Site.Ext object for Smaato
type siteExt struct {
        Data siteExtData `json:"data"`
}

type siteExtData struct {
        Keywords string `json:"keywords"`
}

// bidRequestExt defines BidRequest.Ext object for Smaato
type bidRequestExt struct {
        Client string `json:"client"`
}

// bidExt defines Bid.Ext object for Smaato
type bidExt struct {
        Duration int      `json:"duration"`
        Curls    []string `json:"curls"`
}

// videoExt defines Video.Ext object for Smaato
type videoExt struct {
        Context string `json:"context,omitempty"`
}

// Builder builds a new instance of the Smaato adapter for the given bidder with the given config.
func Builder(bidderName openrtb_ext.BidderName, config config.Adapter, server config.Server) (adapters.Bidder, error) <span class="cov8" title="1">{
        bidder := &amp;adapter{
                clock:    &amp;timeutil.RealTime{},
                endpoint: config.Endpoint,
        }
        return bidder, nil
}</span>

// MakeRequests makes the HTTP requests which should be made to fetch bids.
func (adapter *adapter) MakeRequests(request *openrtb2.BidRequest, reqInfo *adapters.ExtraRequestInfo) ([]*adapters.RequestData, []error) <span class="cov8" title="1">{
        if len(request.Imp) == 0 </span><span class="cov8" title="1">{
                return nil, []error{&amp;errortypes.BadInput{Message: "No impressions in bid request."}}
        }</span>

        // set data in request that is common for all requests
        <span class="cov8" title="1">if err := prepareCommonRequest(request); err != nil </span><span class="cov8" title="1">{
                return nil, []error{err}
        }</span>

        <span class="cov8" title="1">isVideoEntryPoint := reqInfo.PbsEntryPoint == metrics.ReqTypeVideo

        if isVideoEntryPoint </span><span class="cov8" title="1">{
                return adapter.makePodRequests(request)
        }</span> else<span class="cov8" title="1"> {
                return adapter.makeIndividualRequests(request)
        }</span>
}

// MakeBids unpacks the server's response into Bids.
func (adapter *adapter) MakeBids(internalRequest *openrtb2.BidRequest, externalRequest *adapters.RequestData, response *adapters.ResponseData) (*adapters.BidderResponse, []error) <span class="cov8" title="1">{
        if response.StatusCode == http.StatusNoContent </span><span class="cov8" title="1">{
                return nil, nil
        }</span>

        <span class="cov8" title="1">if response.StatusCode != http.StatusOK </span><span class="cov8" title="1">{
                return nil, []error{&amp;errortypes.BadServerResponse{
                        Message: fmt.Sprintf("Unexpected status code: %d. Run with request.debug = 1 for more info.", response.StatusCode),
                }}
        }</span>

        <span class="cov8" title="1">var bidResp openrtb2.BidResponse
        if err := jsonutil.Unmarshal(response.Body, &amp;bidResp); err != nil </span><span class="cov0" title="0">{
                return nil, []error{err}
        }</span>

        <span class="cov8" title="1">bidResponse := adapters.NewBidderResponseWithBidsCapacity(5)

        adMarkupType, err := getAdMarkupType(response)
        if err != nil </span><span class="cov8" title="1">{
                return nil, []error{err}
        }</span>

        <span class="cov8" title="1">var errors []error
        for _, seatBid := range bidResp.SeatBid </span><span class="cov8" title="1">{
                for i := 0; i &lt; len(seatBid.Bid); i++ </span><span class="cov8" title="1">{
                        bid := seatBid.Bid[i]

                        bidExt, err := extractBidExt(&amp;bid)
                        if err != nil </span><span class="cov8" title="1">{
                                errors = append(errors, err)
                                continue</span>
                        }

                        <span class="cov8" title="1">bid.AdM, err = renderAdMarkup(adMarkupType, &amp;bidExt, bid)
                        if err != nil </span><span class="cov8" title="1">{
                                errors = append(errors, err)
                                continue</span>
                        }

                        <span class="cov8" title="1">bidType, err := convertAdMarkupTypeToMediaType(adMarkupType)
                        if err != nil </span><span class="cov0" title="0">{
                                errors = append(errors, err)
                                continue</span>
                        }

                        <span class="cov8" title="1">bidVideo, err := buildBidVideo(&amp;bid, &amp;bidExt, bidType)
                        if err != nil </span><span class="cov0" title="0">{
                                errors = append(errors, err)
                                continue</span>
                        }

                        <span class="cov8" title="1">bid.Exp = adapter.getTTLFromHeaderOrDefault(response)

                        bidResponse.Bids = append(bidResponse.Bids, &amp;adapters.TypedBid{
                                Bid:      &amp;bid,
                                BidType:  bidType,
                                BidVideo: bidVideo,
                        })</span>
                }
        }
        <span class="cov8" title="1">return bidResponse, errors</span>
}

func (adapter *adapter) makeIndividualRequests(request *openrtb2.BidRequest) ([]*adapters.RequestData, []error) <span class="cov8" title="1">{
        imps := request.Imp

        requests := make([]*adapters.RequestData, 0, len(imps))
        errors := make([]error, 0, len(imps))

        for _, imp := range imps </span><span class="cov8" title="1">{
                impsByMediaType, err := splitImpressionsByMediaType(&amp;imp)
                if err != nil </span><span class="cov8" title="1">{
                        errors = append(errors, err)
                        continue</span>
                }

                <span class="cov8" title="1">for _, impByMediaType := range impsByMediaType </span><span class="cov8" title="1">{
                        request.Imp = []openrtb2.Imp{impByMediaType}
                        if err := prepareIndividualRequest(request); err != nil </span><span class="cov8" title="1">{
                                errors = append(errors, err)
                                continue</span>
                        }

                        <span class="cov8" title="1">requestData, err := adapter.makeRequest(request)
                        if err != nil </span><span class="cov0" title="0">{
                                errors = append(errors, err)
                                continue</span>
                        }

                        <span class="cov8" title="1">requests = append(requests, requestData)</span>
                }
        }

        <span class="cov8" title="1">return requests, errors</span>
}

func splitImpressionsByMediaType(imp *openrtb2.Imp) ([]openrtb2.Imp, error) <span class="cov8" title="1">{
        if imp.Banner == nil &amp;&amp; imp.Video == nil &amp;&amp; imp.Native == nil </span><span class="cov8" title="1">{
                return nil, &amp;errortypes.BadInput{Message: "Invalid MediaType. Smaato only supports Banner, Video and Native."}
        }</span>

        <span class="cov8" title="1">imps := make([]openrtb2.Imp, 0, 3)

        if imp.Banner != nil </span><span class="cov8" title="1">{
                impCopy := *imp
                impCopy.Video = nil
                impCopy.Native = nil
                imps = append(imps, impCopy)
        }</span>

        <span class="cov8" title="1">if imp.Video != nil </span><span class="cov8" title="1">{
                impCopy := *imp
                impCopy.Banner = nil
                impCopy.Native = nil
                imps = append(imps, impCopy)
        }</span>

        <span class="cov8" title="1">if imp.Native != nil </span><span class="cov8" title="1">{
                imp.Banner = nil
                imp.Video = nil
                imps = append(imps, *imp)
        }</span>

        <span class="cov8" title="1">return imps, nil</span>
}

func (adapter *adapter) makePodRequests(request *openrtb2.BidRequest) ([]*adapters.RequestData, []error) <span class="cov8" title="1">{
        pods, orderedKeys, errors := groupImpressionsByPod(request.Imp)
        requests := make([]*adapters.RequestData, 0, len(pods))

        for _, key := range orderedKeys </span><span class="cov8" title="1">{
                request.Imp = pods[key]

                if err := preparePodRequest(request); err != nil </span><span class="cov8" title="1">{
                        errors = append(errors, err)
                        continue</span>
                }

                <span class="cov8" title="1">requestData, err := adapter.makeRequest(request)
                if err != nil </span><span class="cov0" title="0">{
                        errors = append(errors, err)
                        continue</span>
                }

                <span class="cov8" title="1">requests = append(requests, requestData)</span>
        }

        <span class="cov8" title="1">return requests, errors</span>
}

func (adapter *adapter) makeRequest(request *openrtb2.BidRequest) (*adapters.RequestData, error) <span class="cov8" title="1">{
        reqJSON, err := json.Marshal(request)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">headers := http.Header{}
        headers.Add("Content-Type", "application/json;charset=utf-8")
        headers.Add("Accept", "application/json")

        return &amp;adapters.RequestData{
                Method:  "POST",
                Uri:     adapter.endpoint,
                Body:    reqJSON,
                Headers: headers,
                ImpIDs:  openrtb_ext.GetImpIDs(request.Imp),
        }, nil</span>
}

func getAdMarkupType(response *adapters.ResponseData) (adMarkupType, error) <span class="cov8" title="1">{
        if admType := adMarkupType(response.Headers.Get("X-Smt-Adtype")); admType != "" </span><span class="cov8" title="1">{
                return admType, nil
        }</span> else<span class="cov8" title="1"> {
                return "", &amp;errortypes.BadServerResponse{
                        Message: fmt.Sprintf("X-Smt-Adtype header is missing."),
                }
        }</span>
}

func (adapter *adapter) getTTLFromHeaderOrDefault(response *adapters.ResponseData) int64 <span class="cov8" title="1">{
        ttl := int64(300)

        if expiresAtMillis, err := strconv.ParseInt(response.Headers.Get("X-Smt-Expires"), 10, 64); err == nil </span><span class="cov8" title="1">{
                nowMillis := adapter.clock.Now().UnixNano() / 1000000
                ttl = (expiresAtMillis - nowMillis) / 1000
                if ttl &lt; 0 </span><span class="cov8" title="1">{
                        ttl = 0
                }</span>
        }

        <span class="cov8" title="1">return ttl</span>
}

func renderAdMarkup(adMarkupType adMarkupType, bidExt *bidExt, bid openrtb2.Bid) (string, error) <span class="cov8" title="1">{
        switch adMarkupType </span>{
        case smtAdTypeImg, smtAdTypeRichmedia:<span class="cov8" title="1">
                return extractAdmBanner(bid.AdM, bidExt.Curls), nil</span>
        case smtAdTypeVideo:<span class="cov8" title="1">
                return bid.AdM, nil</span>
        case smtAdTypeNative:<span class="cov8" title="1">
                return extractAdmNative(bid.AdM)</span>
        default:<span class="cov8" title="1">
                return "", &amp;errortypes.BadServerResponse{
                        Message: fmt.Sprintf("Unknown markup type %s.", adMarkupType),
                }</span>
        }
}

func convertAdMarkupTypeToMediaType(adMarkupType adMarkupType) (openrtb_ext.BidType, error) <span class="cov8" title="1">{
        switch adMarkupType </span>{
        case smtAdTypeImg, smtAdTypeRichmedia:<span class="cov8" title="1">
                return openrtb_ext.BidTypeBanner, nil</span>
        case smtAdTypeVideo:<span class="cov8" title="1">
                return openrtb_ext.BidTypeVideo, nil</span>
        case smtAdTypeNative:<span class="cov8" title="1">
                return openrtb_ext.BidTypeNative, nil</span>
        default:<span class="cov0" title="0">
                return "", &amp;errortypes.BadServerResponse{
                        Message: fmt.Sprintf("Unknown markup type %s.", adMarkupType),
                }</span>
        }
}

func prepareCommonRequest(request *openrtb2.BidRequest) error <span class="cov8" title="1">{
        if err := setUser(request); err != nil </span><span class="cov8" title="1">{
                return err
        }</span>

        <span class="cov8" title="1">if err := setSite(request); err != nil </span><span class="cov8" title="1">{
                return err
        }</span>

        <span class="cov8" title="1">setApp(request)
        setDOOH(request)

        return setExt(request)</span>
}

func prepareIndividualRequest(request *openrtb2.BidRequest) error <span class="cov8" title="1">{
        imp := &amp;request.Imp[0]

        if err := setPublisherId(request, imp); err != nil </span><span class="cov8" title="1">{
                return err
        }</span>

        <span class="cov8" title="1">return setImpForAdspace(imp)</span>
}

func preparePodRequest(request *openrtb2.BidRequest) error <span class="cov8" title="1">{
        if len(request.Imp) &lt; 1 </span><span class="cov0" title="0">{
                return &amp;errortypes.BadInput{Message: "No impressions in bid request."}
        }</span>

        <span class="cov8" title="1">if err := setPublisherId(request, &amp;request.Imp[0]); err != nil </span><span class="cov8" title="1">{
                return err
        }</span>

        <span class="cov8" title="1">return setImpForAdBreak(request.Imp)</span>
}

func setUser(request *openrtb2.BidRequest) error <span class="cov8" title="1">{
        if request.User != nil &amp;&amp; request.User.Ext != nil </span><span class="cov8" title="1">{
                var userExtRaw map[string]json.RawMessage

                if err := jsonutil.Unmarshal(request.User.Ext, &amp;userExtRaw); err != nil </span><span class="cov8" title="1">{
                        return &amp;errortypes.BadInput{Message: "Invalid user.ext."}
                }</span>

                <span class="cov8" title="1">if userExtDataRaw, present := userExtRaw["data"]; present </span><span class="cov8" title="1">{
                        var err error
                        var userExtData userExtData

                        if err = jsonutil.Unmarshal(userExtDataRaw, &amp;userExtData); err != nil </span><span class="cov8" title="1">{
                                return &amp;errortypes.BadInput{Message: "Invalid user.ext.data."}
                        }</span>

                        <span class="cov8" title="1">userCopy := *request.User

                        if userExtData.Gender != "" </span><span class="cov8" title="1">{
                                userCopy.Gender = userExtData.Gender
                        }</span>

                        <span class="cov8" title="1">if userExtData.Yob != 0 </span><span class="cov8" title="1">{
                                userCopy.Yob = userExtData.Yob
                        }</span>

                        <span class="cov8" title="1">if userExtData.Keywords != "" </span><span class="cov8" title="1">{
                                userCopy.Keywords = userExtData.Keywords
                        }</span>

                        <span class="cov8" title="1">delete(userExtRaw, "data")

                        if userCopy.Ext, err = json.Marshal(userExtRaw); err != nil </span><span class="cov0" title="0">{
                                return err
                        }</span>

                        <span class="cov8" title="1">request.User = &amp;userCopy</span>
                }
        }

        <span class="cov8" title="1">return nil</span>
}

func setExt(request *openrtb2.BidRequest) error <span class="cov8" title="1">{
        var err error

        request.Ext, err = json.Marshal(bidRequestExt{Client: clientVersion})

        return err
}</span>

func setSite(request *openrtb2.BidRequest) error <span class="cov8" title="1">{
        if request.Site != nil </span><span class="cov8" title="1">{
                siteCopy := *request.Site

                if request.Site.Ext != nil </span><span class="cov8" title="1">{
                        var siteExt siteExt

                        if err := jsonutil.Unmarshal(request.Site.Ext, &amp;siteExt); err != nil </span><span class="cov8" title="1">{
                                return &amp;errortypes.BadInput{Message: "Invalid site.ext."}
                        }</span>

                        <span class="cov8" title="1">siteCopy.Keywords = siteExt.Data.Keywords
                        siteCopy.Ext = nil</span>
                }
                <span class="cov8" title="1">request.Site = &amp;siteCopy</span>
        }

        <span class="cov8" title="1">return nil</span>
}

func setApp(request *openrtb2.BidRequest) <span class="cov8" title="1">{
        if request.App != nil </span><span class="cov8" title="1">{
                appCopy := *request.App
                request.App = &amp;appCopy
        }</span>
}

func setDOOH(request *openrtb2.BidRequest) <span class="cov8" title="1">{
        if request.DOOH != nil </span><span class="cov8" title="1">{
                doohCopy := *request.DOOH
                request.DOOH = &amp;doohCopy
        }</span>
}

func setPublisherId(request *openrtb2.BidRequest, imp *openrtb2.Imp) error <span class="cov8" title="1">{
        publisherID, err := jsonparser.GetString(imp.Ext, "bidder", "publisherId")
        if err != nil </span><span class="cov8" title="1">{
                return &amp;errortypes.BadInput{Message: "Missing publisherId parameter."}
        }</span>

        <span class="cov8" title="1">if request.Site != nil </span><span class="cov8" title="1">{
                // Site is already a copy
                request.Site.Publisher = &amp;openrtb2.Publisher{ID: publisherID}
                return nil
        }</span> else<span class="cov8" title="1"> if request.App != nil </span><span class="cov8" title="1">{
                // App is already a copy
                request.App.Publisher = &amp;openrtb2.Publisher{ID: publisherID}
                return nil
        }</span> else<span class="cov8" title="1"> if request.DOOH != nil </span><span class="cov8" title="1">{
                // DOOH is already a copy
                request.DOOH.Publisher = &amp;openrtb2.Publisher{ID: publisherID}
                return nil
        }</span> else<span class="cov8" title="1"> {
                return &amp;errortypes.BadInput{Message: "Missing Site/App/DOOH."}
        }</span>
}

func setImpForAdspace(imp *openrtb2.Imp) error <span class="cov8" title="1">{
        adSpaceID, err := jsonparser.GetString(imp.Ext, "bidder", "adspaceId")
        if err != nil </span><span class="cov8" title="1">{
                return &amp;errortypes.BadInput{Message: "Missing adspaceId parameter."}
        }</span>

        <span class="cov8" title="1">impExt, err := makeImpExt(&amp;imp.Ext)
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span>

        <span class="cov8" title="1">if imp.Banner != nil || imp.Video != nil || imp.Native != nil </span><span class="cov8" title="1">{
                imp.TagID = adSpaceID
                imp.Ext = impExt
                return nil
        }</span>

        <span class="cov0" title="0">return nil</span>
}

func setImpForAdBreak(imps []openrtb2.Imp) error <span class="cov8" title="1">{
        if len(imps) &lt; 1 </span><span class="cov0" title="0">{
                return &amp;errortypes.BadInput{Message: "No impressions in bid request."}
        }</span>

        <span class="cov8" title="1">adBreakID, err := jsonparser.GetString(imps[0].Ext, "bidder", "adbreakId")
        if err != nil </span><span class="cov8" title="1">{
                return &amp;errortypes.BadInput{Message: "Missing adbreakId parameter."}
        }</span>

        <span class="cov8" title="1">impExt, err := makeImpExt(&amp;imps[0].Ext)
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span>

        <span class="cov8" title="1">for i := range imps </span><span class="cov8" title="1">{
                imps[i].TagID = adBreakID
                imps[i].Ext = nil

                videoCopy := *(imps[i].Video)

                videoCopy.Sequence = int8(i + 1)
                videoCopy.Ext, _ = json.Marshal(&amp;videoExt{Context: "adpod"})

                imps[i].Video = &amp;videoCopy
        }</span>

        <span class="cov8" title="1">imps[0].Ext = impExt

        return nil</span>
}

func makeImpExt(impExtRaw *json.RawMessage) (json.RawMessage, error) <span class="cov8" title="1">{
        var impExt openrtb_ext.ExtImpExtraDataSmaato

        if err := jsonutil.Unmarshal(*impExtRaw, &amp;impExt); err != nil </span><span class="cov0" title="0">{
                return nil, &amp;errortypes.BadInput{Message: "Invalid imp.ext."}
        }</span>

        <span class="cov8" title="1">if impExtSkadnRaw := impExt.Skadn; impExtSkadnRaw != nil </span><span class="cov8" title="1">{
                var impExtSkadn map[string]json.RawMessage

                if err := jsonutil.Unmarshal(impExtSkadnRaw, &amp;impExtSkadn); err != nil </span><span class="cov8" title="1">{
                        return nil, &amp;errortypes.BadInput{Message: "Invalid imp.ext.skadn."}
                }</span>
        }

        <span class="cov8" title="1">if impExtJson, err := json.Marshal(impExt); string(impExtJson) != "{}" </span><span class="cov8" title="1">{
                return impExtJson, err
        }</span> else<span class="cov8" title="1"> {
                return nil, nil
        }</span>
}

func groupImpressionsByPod(imps []openrtb2.Imp) (map[string]([]openrtb2.Imp), []string, []error) <span class="cov8" title="1">{
        pods := make(map[string][]openrtb2.Imp)
        orderKeys := make([]string, 0)
        errors := make([]error, 0, len(imps))

        for _, imp := range imps </span><span class="cov8" title="1">{
                if imp.Video == nil </span><span class="cov8" title="1">{
                        errors = append(errors, &amp;errortypes.BadInput{Message: "Invalid MediaType. Smaato only supports Video for AdPod."})
                        continue</span>
                }

                <span class="cov8" title="1">pod := strings.Split(imp.ID, "_")[0]
                if _, present := pods[pod]; !present </span><span class="cov8" title="1">{
                        orderKeys = append(orderKeys, pod)
                }</span>
                <span class="cov8" title="1">pods[pod] = append(pods[pod], imp)</span>
        }
        <span class="cov8" title="1">return pods, orderKeys, errors</span>
}

func buildBidVideo(bid *openrtb2.Bid, bidExt *bidExt, bidType openrtb_ext.BidType) (*openrtb_ext.ExtBidPrebidVideo, error) <span class="cov8" title="1">{
        if bidType != openrtb_ext.BidTypeVideo </span><span class="cov8" title="1">{
                return nil, nil
        }</span>

        <span class="cov8" title="1">if bidExt == nil </span><span class="cov0" title="0">{
                return nil, nil
        }</span>

        <span class="cov8" title="1">var primaryCategory string
        if len(bid.Cat) &gt; 0 </span><span class="cov8" title="1">{
                primaryCategory = bid.Cat[0]
        }</span>

        <span class="cov8" title="1">return &amp;openrtb_ext.ExtBidPrebidVideo{
                Duration:        bidExt.Duration,
                PrimaryCategory: primaryCategory,
        }, nil</span>
}

func extractBidExt(bid *openrtb2.Bid) (bidExt, error) <span class="cov8" title="1">{
        var bidExt bidExt

        if bid.Ext == nil </span><span class="cov8" title="1">{
                return bidExt, nil
        }</span>
        <span class="cov8" title="1">if err := jsonutil.Unmarshal(bid.Ext, &amp;bidExt); err != nil </span><span class="cov8" title="1">{
                return bidExt, &amp;errortypes.BadServerResponse{Message: "Invalid bid.ext."}
        }</span>
        <span class="cov8" title="1">return bidExt, nil</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
